<script type="text/jsx">
import variables from "../../variables.json";
import browser from "../../utils/browser";

const componentsList = {};

export default {
  name: "RtBannerItem",
  components: componentsList,
  props: {
    hasCustomContent: {
      type: Boolean,
      default: false
    },
    link: {
      type: String,
      default: null
    },
    mobileImageMaxHeight:{
      type: String,
      default: null
    },
    linkTarget: {
      type: String,
      default: null
    },
    ancorHashLink: {
      type: String,
      default: null
    },
    ancorGetParamsLink: {
      type: String,
      default: null
    },
    contentMinHeight: {
      type: [Number, String],
      default: null
    },
    contentHeight: {
      type: [Number, String],
      default: null
    },
    contentMobileMinHeight: {
      type: [Number, String],
      default: null
    },
    contentMobileHeight: {
      type: [Number, String],
      default: null
    },
    contentMinWidth: {
      type: [Number, String],
      default: null
    },
    contentMaxWidth: {
      type: [Number, String],
      default: null
    },
    backgroundVideo: {
      type: String,
      default: null
    },
    backgroundColor: {
      type: String,
      default: null
    },
    backgroundImage: {
      type: String,
      default: null
    },
    backgroundImageMobile: {
      type: String,
      default: null
    },
    backgroundImageTablet: {
      type: String,
      default: null
    },
    backgroundImageWebp: {
      type: String,
      default: null
    },
    lazyImage: {
      type: String,
      default: null
    },
    lazyImageMobile: {
      type: String,
      default: null
    },
    lazyImageTablet: {
      type: String,
      default: null
    },
    preloadImage: {
      type: Boolean,
      default: false
    },
    isWhiteColor: {
      type: Boolean,
      default: false
    },
    backgroundPosition: {
      type: String,
      default: null
    },
    slideTime: {
      type: [String, Number],
      default: null
    },
    isGameBannerItem:{
      type: Boolean,
      default: false
    },
    ga: {
      type: Object,
      default: null
    },
    gaB2b: {
      type: Object,
      default: null
    },
    patternBackground: {
      type: Boolean,
      default: false
    },
    patternTopColor: {
      type: String,
      default: ''
    },
    patternLeftColor: {
      type: String,
      default: ''
    },
    patternRightColor: {
      type: String,
      default: ''
    },
    patternType: {
      type: Number,
      default: 1
    },
    hasImageOnMobile: {
      type: Boolean,
      default: false
    },
    colorFillOnMobile: {
      type: Boolean,
      default: false
    },
    halfHeightImage: {
      type: Boolean,
      default: false
    }
  },
  inject: {
    RtBanners: {}
  },

  data() {
    return {
      id: this._uid,
      index: null
    };
  },

  beforeMount: function() {
    if (this.RtBanners) {
      this.index = this.RtBanners.items.length;
      const bannerItemData = {
        isWhiteColor: this.isWhiteColor,
        id: this.id
      };
      if (this.computedBackgroundImage) {
        bannerItemData.backgroundImage = this.computedLazyImage || this.computedBackgroundImage;
        if (this.computedLazyImage) {
          this.loadImageAsync(this.computedBackgroundImage, img => {
            bannerItemData.backgroundImage = this.computedBackgroundImage;
          });
        }
      }
      if(this.backgroundColor){
        bannerItemData.backgroundColor = this.backgroundColor
      }
      if(this.patternBackground) {
        bannerItemData.patternBackground = this.patternBackground,
        bannerItemData.patternType = this.patternType,
        bannerItemData.patternTopColor = this.patternTopColor,
        bannerItemData.patternLeftColor = this.patternLeftColor,
        bannerItemData.patternRightColor = this.patternRightColor
      }
      if(this.hasImageOnMobile){
        bannerItemData.imageOnMobile = this.hasImageOnMobile;
      }
      if (this.backgroundVideo) {
        bannerItemData.backgroundVideo = this.backgroundVideo;
      }
      if (this.slideTime) {
        bannerItemData.slideTime = this.slideTime;
      }
      if (this.ancorHashLink) {
        bannerItemData.ancorHashLink = this.ancorHashLink;
      }
      if (this.ancorGetParamsLink) {
        bannerItemData.ancorGetParamsLink = this.ancorGetParamsLink;
      }
      if (this.link) {
        bannerItemData.link = this.link;
      }
      if (this.linkTarget) {
        bannerItemData.linkTarget = this.linkTarget;
      }
      if(this.isGameBannerItem) {
        bannerItemData.isGameBannerItem = this.isGameBannerItem;
      }
      if(this.colorFillOnMobile) {
        bannerItemData.colorFillOnMobile = this.colorFillOnMobile
      }
      if(this.halfHeightImage) {
        bannerItemData.halfHeightImage = this.halfHeightImage
      }

      this.RtBanners.items.push(bannerItemData);
      if (this.ancorHashLink && location.hash) {
        if (location.hash.replace(/#/, "") === this.ancorHashLink) {
          this.RtBanners.activeIndex = this.RtBanners.items.length - 1;
        }
      }
      if (this.ancorGetParamsLink) {
        let getParams = location.href.split("?");
        if (getParams.length > 1) {
          if (getParams[1].search(this.ancorGetParamsLink) >= 0) {
            this.RtBanners.activeIndex = this.RtBanners.items.length - 1;
          }
        }
      }
      if (this.preloadImage || this.computedLazyImage) {
        const preloadImage = new Image()
        preloadImage.src = this.computedBackgroundImage
      }
    }
  },
  computed: {
    bannerItemWrapperClass(){
      let bannerItemWrapperClass = "";
      if(this.isGameBannerItem){
        bannerItemWrapperClass += 'rt-banner__item-wrapper rt-banner__item-wrapper-game';
      }
      return bannerItemWrapperClass;
    },
    bannerStyle() {
      const styles = {};

      if (this.contentMinWidth !== null) {
        styles.minWidth = this.normalizeVariable(this.contentMinWidth);
      }
      if (this.contentMaxWidth !== null) {
        styles.maxWidth = this.normalizeVariable(this.contentMaxWidth);
      }
      if (!this.RtBanners.isMobile) {
        if (this.contentMinHeight) {
          styles.minHeight = this.normalizeVariable(this.contentMinHeight);
        }
        if (this.contentHeight) {
          styles.height = this.normalizeVariable(this.contentHeight);
        }
        if (this.mobileImageMaxHeight) {
          styles.maxHeight = this.mobileImageMaxHeight;
        }
      } else {
        if (this.contentMobileMinHeight !== null) {
          styles.minHeight = this.normalizeVariable(
            this.contentMobileMinHeight
          );
        }
        if (this.contentMobileHeight !== null) {
          styles.height = this.normalizeVariable(this.contentMobileHeight);
        }
      }

      return styles;
    },
    bannerClass() {
      let className = " rt-banner__item-wrapper";
      if (this.RtBanners && this.RtBanners.activeIndex === this.index) {
        className += " rt-banner-content--active";
      }

      return className;
    },

    computedBackgroundImage () {
      return this.computedBackgroundImageFn()
    },
    computedLazyImage () {
      let result
      if (this.isMobile() && this.lazyImageMobile) {
        result = this.lazyImageMobile
      } else if (this.isTablet() && this.lazyImageTablet) {
        result = this.lazyImageTablet
      } else {
        result = this.lazyImage
      }
      return result
    }
  },
  mounted () {
    if (this.ga) {
      this.activateEventToLink('b2c', this.ga);
    }
    if (this.gaB2b) {
      this.activateEventToLink('b2b', this.gaB2b);
    }
    window.addEventListener('resize', ()=>{
      let computedBackgroundImage = this.computedBackgroundImageFn();
      if (computedBackgroundImage){
        this.$forceUpdate()

        if(this.RtBanners.items[this.index]) {
          this.RtBanners.items[this.index].backgroundImage = computedBackgroundImage;

          if (this.computedLazyImage) {
            this.loadImageAsync(computedBackgroundImage, img => {
              this.RtBanners.items[this.index].backgroundImage = computedBackgroundImage;
            });
          }
        }
      }
    })

  },
  methods: {
    isMobile () {
      return browser.isMobile()
    },
    isTablet () {
      return browser.isTablet()
    },
    computedBackgroundImageFn(){
      let result
      if (this.isMobile() && this.backgroundImageMobile) {
        result = this.backgroundImageMobile
      } else if (this.isTablet() && this.backgroundImageTablet) {
        result = this.backgroundImageTablet
      } else if (browser.supportedWebP && this.backgroundImageWebp) {
        result = this.backgroundImageWebp
      } else {
        result = this.backgroundImage
      }
      return result
    },
    normalizeVariable(variable) {
      if (typeof variable === "number") {
        variable += "px";
      }
      return variable;
    },
    activateEventToLink (typeEvent, ga) {
      if (this.$el.querySelector('a')) {
        let parentId = this.RtBanners.id;
        let currentKey = this.index;
        this.$el.querySelector('a').addEventListener('click', function(e){
          if (!this.getAttribute('data-ga-pushed')) {
            e.preventDefault();
            if (!window.dataLayer) {
              window.dataLayer = [];
            }
            window.dataLayer.push({
              event: typeEvent,
              type: 'banner_click',
              banner_name: ga.name,
              banner_id: parentId,
              banner_place: currentKey + 1,
              banner_section: ga.section || window.location.pathname
            });
            this.setAttribute('data-ga-pushed', 'true');
            this.click();
          }
        }, false);
      }
    },
    loadImageAsync (src, resolve, reject=function(err){}) {
      let image = new Image();
      image.src = src;
      image.onload = function () {
        resolve({
          naturalHeight: image.naturalHeight,
          naturalWidth: image.naturalWidth,
          src: image.src
        });
      };
      image.onerror = function (e) {
        reject(e);
      };
    }
  },
  render(h){
    const content = () => {
      if(this.isGameBannerItem){
        return <rt-banner-video-game-contron></rt-banner-video-game-contron>;
      }
      return null;
    };
    //return <div style={this.bannerStyle} class={"rt-banner__item" + (this.RtBanners.activeIndex === this.index ? " rt-banner__item--is-active" : "")} >{this.$slots.default}</div>
    if (this.hasCustomContent) {
      let bannerClass = "rt-banner__item";
      if(this.RtBanners.activeIndex) {
        bannerClass += " rt-banner__item--is-active";
      }

      //return <div style={this.bannerStyle} class={"rt-banner__item" + (this.RtBanners.activeIndex === this.index ? " rt-banner__item--is-active" : "")} >{this.$slots.default}</div>
      return <div class={"rt-banner__item" + (this.RtBanners.activeIndex === this.index ? " rt-banner__item--is-active" : "")} style={this.bannerStyle}>
        {this.$slots.default}
        {content()}
        </div>;
    } else {

      return <div style={this.bannerStyle} class={"rt-banner-content" + this.bannerClass}>
          <div class="rt-banner-content__inner">
            {this.$slots.default}
            {content()}
            </div>
        </div>
    }
  }
};
</script>
